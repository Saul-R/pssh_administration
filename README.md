# Utilidades para la configuracion y mantenimiento de la plataforma

La ruta de despliegue es `/opt/cluster-admin`

## CREACION DE USUARIOS:

Es importante que la creación de usuarios, salvo causa de fuerza mayor, se realice desde el job que se ha preparado para ello, teniendo el proxy levantado acceder al jenkins:

http://frontend:8080/job/Administracion/job/Gestion%20de%20Usuarios/job/Creacion%20de%20usuarios%20con%20contrase%C3%B1a%20aleatoria%20opcional/

Una vez en este job:
![Job jenkins](https://i.imgur.com/RX9j3OJ.png)

Basta con pulsar "Build with parameters" que nos solicitará los detalles para la creación de los usuarios.

![crear usuario](https://i.imgur.com/279Ev6l.png)

Pulsar el boton de ejecución y ya tendríamos un usuario creado.

Para borrar usuarios creados de esta forma se ha desarrollado un job analogo al anterior, que recibe como parámetro el nombre de usuario y lo borra del clúster.
http://frontend:8080/job/Administracion/job/Gestion%20de%20Usuarios/job/Borrar%20usuarios/

## sbin

Utilidades para administración (permisos elevados).

### cluster-bulk-useradd
Añade lista de usuarios
```
Usage: /usr/sbin/cluster-bulk-useradd [options] <number of users>
 Options:
 	--user-prefix <prefix>: The prefix of the name for the users created. (default = user)
 	--password-file <prefix>: The file to store autogenerated password for each user. (default = ./passwords)
```
Eg:

```
./cluster-bulk-useradd --user-prefix santander 5
```
Creará 5 usuarios (santander1 santander2 santander3 santander4 santander5) y un archivo de contraseñas (./passwords) donde se guardarán las contraseñas generadas.

### cluster-bulk-userdel

Borra usuarios creados con el `cluster-bulk-useradd`.

```
Usage: /usr/sbin/cluster-bulk-userdel [options] <number of users>
 Options:
 	--user-prefix <prefix>: The prefix of the name for the users created. (default = user)
 	--purge: Removes the user's local home directory and the HDFS home directory.

```


### cluster-adduser
Agrega un usuario al grupo que se le pase como parámetro. Útil para crear usuarios administradores (basta con agregarlos al grupo `admin`).
```
Usage: /usr/sbin/cluster-adduser <user> <group>
```

### cluster-deluser
Quita el usuario de un grupo en todos los nodos del clúster.
```
Usage: /usr/sbin/cluster-deluser <user> <group>
```

### cluster-groupadd
Añade el grupo que se le pase como parámetro en todos los nodos del clúster. 

```
Usage: /usr/sbin/cluster-groupadd <groupname>
```

### cluster-groupdel
Borra el grupo que se le pase como parámetro en todos los nodos del clúster. 

### cluster-passwd
Cambia la contraseña del usuario del sistema operativo en todos los nodos del clúster.

```
Usage: /usr/sbin/cluster-passwd <user>

```
### cluster-start-all-services
Inicia todos los servicios del cluster. Este script se llama automáticamente al reiniciar.

Actualmente estos servicios son además de los de CDH, cassandra y jupyterhub. Si se quieren incluir cualquier otro servicio en el clúster, se tendría que incluir aquí.

### cluster-stop-all-services
Analogo al start-all-services, para todos los servicios


### cluster-start-cdh-services
Inicia los servicios gestionados con Cloudera Manager (hive, yarn, hdfs ...).
Es un wrapper del `../bin/start-cdh-services.py`. Simplemente llama a este archivo configurando previamente las variables de entorno del clúster.

### cluster-stop-cdh-services
Análogo al start-cdh-services, llama al script de `../bin/stop-cdh-services.py` y detiene los servicios gestionados con CM (Cloudera manager)

### cluster-useradd

Añade un usuario a todos los nodos del cluster, crea su hoome en hdfs, configura acceso passwordless al resto de nodos del cluster para su mismo usuario y crea su usuario en cassandra.
Pide la contraseña de forma interactiva.

Como nota, jupyterhub tiene de motor de autenticacion el PAM del edge node; que traducido quiere decir que las credenciales y los usuarios de este servicio serán los mismos que en el sistema operativo.
(también pasa con usuarios de Rstudio).

```
Usage: /usr/sbin/cluster-useradd <username>
```


### cluster-useradd-password
Este script es idéntico al anterior, con la salvedad de que recibe como parámetro la contraseña del usuario, es el script al que llama jenkins para crear usuarios.

La creación de los usuarios debería hacerse desde el job de jenkins desarrollado para ello: http://frontend:8080/job/Administracion/job/Gestion%20de%20Usuarios/job/Creacion%20de%20usuarios%20con%20contrase%C3%B1a%20aleatoria%20opcional/ .


### cluster-userdel
Borra usuarios creados con el cluster-useradd*


### export-cdh-config.py
Ejemplo de conexión al cloudera manager via api, necesita tener las variables de cloudera manager en el entorno.


--------------------

## bin

### backup-cdh-config.sh
Crea un backup de la configuración en `/etc/cm/backup` con el timestamp de la ejecución. Este backup solo se genera si el script detecta que ha habido cambios en la configuración del cloudera manager.
Este script está incluido en `/etc/cron.daily`, de forma que se ejecuta diariamente. Se puede disparar su ejecución on demand, no recibe ningún parámetro y como ya he comentado sólo se dispara en caso de cambios en la configuración.
Se debe ejecutar con sudo ya que crea archivos temporales en la carpeta de backup.

Ejemplo de ejecución:

```
srodriguez@frontend:~$ sudo /opt/cluster-admin/bin/backup-cdh-config.sh

  This is a Cloudera Manager backup script.

  Example use:
    /opt/cluster-admin/bin/backup-cdh-config.sh

  Will try to backup the conf to the file:
    /etc/cm/backup/cm_conf_20170503_121716

  In any case, if the conf is unchanged it won't create any new file. 

  
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  146k    0  146k    0     0  1817k      0 --:--:-- --:--:-- --:--:-- 1804k

Conf_file unchanged

```
En la ejecución anterior no se creó ningún archivo de respaldo, ya que el último backup y la configuración que se ha intentado respaldar son iguales.

### pscpclone.sh

Script auxiliar que sincroniza un archivo del edge node en la lista de nodos que se le pase como parámetro. 
Este comando no se debe utilizar con sudo, si no con usuario que esté en el grupo `admin`
```
Usage:

/etc/cluster-admin/bin/pscpclone.sh <hostfile> <file-to-sync>
```

Por ejemplo si quisiéramos sincronizar el `/etc/hosts` del edge con todos los nodos del cluster (usuario `admin`):

```
/opt/cluster-admin/bin/pscpclone.sh /etc/cluster-admin/all-hosts /etc/hosts
```

Esta ejecución está programada para correr cada 15 minutos desde el crontab de admin en el frontend.
Es particularmente útil para centralizar la configuración de los servicios que no pueden estar gestionados desde cloudera manager, como Spark2.0.2.

### start-cdh-services.py

Inicia todos los servicios de cdh llamando a la api de cloudera manager.
### stop-cdh-services.py
Detiene todos los servicios de cdh llamando a la api de cloudera manager.
